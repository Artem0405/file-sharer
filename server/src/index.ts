// server/src/index.ts

import express from 'express';
import cors from 'cors';
import { config } from './core/config';
import { logger } from './core/logger';
import { setupDatabase } from './core/database';
import { filesRouter } from './api/files.controller';

// 1. –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Express
const app = express();

// 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º "Middleware" - —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
//    –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω –ø–æ–ø–∞–¥–µ—Ç –≤ –Ω–∞—à–∏ —Ä–æ—É—Ç—ã.
app.use(cors()); // –ü–æ–∑–≤–æ–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω–∞—à–µ–º—É API —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞
app.use(express.json()); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç JSON –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞

// --- –†–û–£–¢–´ ---
// 3. –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä.
//    –≠—Ç–æ –≥–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ–π –ª–æ–≥–∏–∫–∏ API.
//    –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "/api/files", –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ filesRouter.
app.use('/api/files', filesRouter);

// --- –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê ---
// 4. –°–æ–∑–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è
//    –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î).
async function startServer() {
  // –°–Ω–∞—á–∞–ª–∞ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ
  await setupDatabase();

  // –ó–∞—Ç–µ–º –Ω–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
  app.listen(config.port, () => {
    logger.info(`üöÄ Server is running at http://localhost:${config.port}`);
  });
}

// 5. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–ø—É—Å–∫–∞ –∏ –ª–æ–≤–∏–º –ª—é–±—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.
startServer().catch((error) => {
  logger.error(error, 'Failed to start server');
  process.exit(1); // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è, –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –æ—à–∏–±–∫–æ–π
});